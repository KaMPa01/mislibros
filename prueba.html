<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz5h4YbUvydEVw3uMWq--C4A631mJduMMLy0Yy3KSUw1ilZ1XQHuenkfHC50xaKpapQ/exec";

    const form = document.getElementById('reserva-form');
    const firmadoRadios = document.querySelectorAll('input[name="firmado"]');
    const firmaContainer = document.getElementById('firma-container');
    const metodoEnvio = document.getElementById('metodo_envio');
    
    const inpostMapBtn = document.getElementById('inpost-map-btn');
    const selectedInpostPointInfo = document.getElementById('selected-inpost-point-info');
    const inpostPointIdInput = document.getElementById('inpost_point_id');
    const inpostPointAddressInput = document.getElementById('inpost_point_address');

    firmadoRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            firmaContainer.classList.toggle('hidden', e.target.value !== 'Sí');
        });
    });

    metodoEnvio.addEventListener('change', () => {
        const selected = metodoEnvio.value.toLowerCase();
        const isCorreos = selected.includes('correos');
        const isInpost = selected.includes('inpost');

        document.getElementById('direccion-correos').classList.toggle('hidden', !isCorreos);
        document.getElementById('punto-inpost').classList.toggle('hidden', !isInpost);

        document.getElementById('direccion').required = isCorreos;
        document.getElementById('poblacion').required = isCorreos;
        document.getElementById('provincia').required = isCorreos;
        document.getElementById('cp').required = isCorreos;
        
        inpostPointIdInput.required = isInpost;
        inpostPointAddressInput.required = isInpost;
    });
    
    // ⚙️ LÓGICA DE INPOST ACTUALIZADA
    inpostMapBtn.addEventListener('click', () => {
        // ✨ VERIFICACIÓN DE SEGURIDAD
        // Comprobamos si la librería de InPost se ha cargado correctamente en la ventana
        if (typeof inpost === 'undefined' || typeof inpost.geowidget === 'undefined') {
            console.error("Error: La librería GeoWidget de InPost no se ha cargado.");
            alert("No se pudo cargar el mapa de puntos de recogida. Por favor, revisa tu conexión o si tienes algún bloqueador de scripts activo, y refresca la página.");
            return; // Detenemos la ejecución si la librería no está disponible
        }

        // Si todo está correcto, abrimos el mapa
        inpost.geowidget.open(point => {
            console.log('Punto seleccionado:', point);
            
            const address = point.address_details;
            const fullAddress = `${address.street} ${address.building_number}, ${address.post_code} ${address.city}`;

            inpostPointIdInput.value = point.name;
            inpostPointAddressInput.value = fullAddress;
            
            selectedInpostPointInfo.innerHTML = `
                <strong>Punto seleccionado:</strong><br>
                ${point.name} - ${point.location_description}<br>
                ${fullAddress}
            `;
            selectedInpostPointInfo.classList.remove('hidden');

            inpostPointIdInput.dispatchEvent(new Event('input'));
            inpostPointAddressInput.dispatchEvent(new Event('input'));

        }, { language: 'es' });
    });


    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitButton = document.getElementById('submit-button');
        const modal = document.getElementById('modal');
        const modalLoader = document.getElementById('modal-loader');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        submitButton.disabled = true;
        submitButton.textContent = 'Enviando...';
        
        modal.classList.remove('hidden');
        modalLoader.classList.remove('hidden');
        modalCloseBtn.classList.add('hidden');
        modalTitle.textContent = 'Procesando...';
        modalMessage.textContent = 'Estamos guardando tu reserva. Por favor, espera.';

        const fileInput = document.getElementById('justificante_pago_file');
        let paymentProofData = null;

        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const base64String = await toBase64(file);
            paymentProofData = {
                fileName: file.name,
                mimeType: file.type,
                base64Data: base64String.split(',')[1]
            };
        }

        const formData = new FormData(form);
        const data = {};
        formData.forEach((value, key) => {
            if (key !== 'justificante_pago_file') {
                data[key] = value;
            }
        });

        const payload = {
            action: 'submitOrder',
            orderData: data,
            paymentProof: paymentProofData
        };

        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            modalLoader.classList.add('hidden');
            modalCloseBtn.classList.remove('hidden');

            if (result.success) {
                modalTitle.textContent = '¡Reserva Confirmada!';
                modalMessage.textContent = 'Gracias por tu pedido. He recibido tus datos correctamente.';
                form.reset();
                document.getElementById('direccion-correos').classList.add('hidden');
                document.getElementById('punto-inpost').classList.add('hidden');
                selectedInpostPointInfo.classList.add('hidden');
                firmaContainer.classList.add('hidden');
            } else {
                throw new Error(result.message || 'Error desconocido');
            }
        } catch (error) {
            modalTitle.textContent = 'Error en la Reserva';
            modalMessage.textContent = `Hubo un problema al procesar tu pedido: ${error.message}. Por favor, inténtalo de nuevo.`;
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Confirmar Reserva';
        }
    });

    document.getElementById('modal-close-btn').addEventListener('click', () => {
        document.getElementById('modal').classList.add('hidden');
    });
</script>
